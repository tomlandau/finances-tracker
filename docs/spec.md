# אפיון מערכת ניהול כספים אישי ועסקי

סקרייפינג אוטומטי · סיווג חכם · תחזית תזרים · תובנות

גרסה: 1.0 | תאריך: פברואר 2026 | ביצוע: Claude Code

---

## רקע ומצב קיים

### מי אנחנו

משפחה של שני עצמאים בעלי עסקים, מנהלים משק בית עם שני פעוטות. הכספים מהעסקים נכנסים לאורך כל החודש בסכומים ובתזמונים משתנים.

### המצב הפיננסי

חשבון בנק אחד בדיסקונט מרכז את כל הפעילות הפיננסית - אישית ועסקית גם יחד. 8 כרטיסי אשראי (כאל ומקס) ללא הפרדה בין אישי לעסקי. אין כרטיסים ייעודיים לעסק מסוים.

העסקים מנוהלים באמצעות Sumit - עוסק מורשה ועוסק פטור. חשבוניות פתוחות כמעט לא קיימות.

### הבעיה המרכזית

ב-10 לכל חודש יורדים בו-זמנית: כרטיסי אשראי, משכנתא, גן פרטי, הוראות קבע לפנסיות, קרנות השתלמות וקופות גמל. לעיתים הכספים החודשיים עדיין לא הספיקו להיכנס לחשבון, מה שגורם לחיובים באשראי ובהוראות קבע.

הבעיה היא כפולה: לפעמים החודש כן מסתיים בפלוס אבל לא בתזמון הנכון, ולפעמים יש יותר הוצאות מהכנסות.

### מה קיים היום

אפליקציית React PWA מאוחסנת על Vercel, דמויית Toshl, למעקב אחרי הוצאות והכנסות. האפליקציה משתמשת ב-Airtable כ-DB וכוללת הפרדה בין בית לבין כל אחד מהעסקים.

בנוסף, קיימים Airtable bases נפרדים לניהול לקוחות עבור כל אחד מהעסקים, ובהם מופיעות גם הכנסות עתידיות.

ההזנה היום היא ידנית לחלוטין, אין תמונת תזרים אמיתית, ואין יכולת זיהוי אוטומטית של הוצאות והכנסות מהבנק ומהאשראי.

---

## מטרות הפרויקט

### 1. הזנה אוטומטית של הוצאות והכנסות

תנועות מכרטיסי אשראי ומחשבון הבנק ייסקרפו אוטומטית פעם ביום, יסווגו לקטגוריות ולישויות (בית/עסק א׳/עסק ב׳), וישויכו להוצאות/הכנסות באפליקציה. המערכת תלמד מכל סיווג ותצבור חוקים לעתיד.

### 2. מעקב תזרים

תחזית תזרים לקראת ה-10 לחודש בשלושה תרחישים (פסימי, ריאליסטי, אופטימי) בהתחשב ביתרת הבנק, הכנסות צפויות, חיובי אשראי צפויים, והוראות קבע ידועות. מאפשר היערכות למצב של חוסר ולהיגב מראש.

### 3. תובנות (Insights)

ניתוח הכנסות מול הוצאות לפי קטגוריות, ישויות, טרנדים חודשיים, והשוואות תקופתיות. המטרה - להבין איפה אפשר לחסוך ולאן הולך הכסף.

---

## Stack טכנולוגי

| תפקיד | טכנולוגיה | הערות |
|---|---|---|
| סקרייפר + Cron + סיווג | Railway (Node.js) | סקרייפינג, סיווג, כתיבה ל-Airtable |
| מסד נתונים | Airtable (קיים) | תנועות, הוצאות/הכנסות, חוקים |
| Frontend | React PWA על Vercel (קיים) | דשבורד, סיווג, תובנות |
| חשבוניות | Sumit REST API | שליפת חשבוניות + cross-reference |
| התראות | Telegram Bot | סיכומים + סיווג אינטראקטיבי |
| הכנסות עתידיות | Airtable bases לקוחות | נתוני לקוחות של שני העסקים |
| Credentials | Railway env vars + AES | הצפנה כפולה |
| סקרייפינג | israeli-bank-scrapers | דיסקונט, כאל, מקס |

---

## אבטחת Credentials

המערכת מחזיקה credentials רגישים - שם משתמש וסיסמה לחשבון בנק ולכרטיסי אשראי.

### שכבת אחסון

Credentials נשמרים כ-environment variables מוצפנים ב-Railway. שכבת הצפנה נוספת עם AES (crypto.createCipheriv) עם מפתח נפרד - כך גם אם מישהו מקבל גישה ל-env vars, הוא צריך גם את מפתח ההצפנה.

### כללים

לא לשמור credentials בקוד, ב-Airtable, או בשום מקום עם UI נגיש. להפעיל 2FA על Railway, GitHub, ו-Airtable. לבדוק אפשרות למשתמש צפייה בלבד בדיסקונט - כך גם במקרה של פריצה לא יוכלו לבצע פעולות בחשבון.

---

## מבנה נתונים ב-Airtable

הטבלאות החדשות מצטרפות ל-base הקיים. מבנה הטבלאות הקיימות יושלם בנפרד ל-Claude Code.

### Transactions (חדש)

| שדה | סוג | תיאור |
|---|---|---|
| transaction_id | Formula | hash של תאריך+סכום+תיאור+כרטיס למניעת כפילויות |
| date | Date | תאריך התנועה |
| amount | Currency | סכום |
| description | Single line text | תיאור מהסקרייפר |
| source | Single select | שם הכרטיס/חשבון בנק |
| status | Single select | pending / auto_classified / manually_classified |
| classified_by_rule | Link | קישור ל-Classification Rules |
| linked_record | Link | קישור להוצאות/הכנסות |

### Classification Rules (חדש)

| שדה | סוג | תיאור |
|---|---|---|
| match_pattern | Single line text | שם עסק או חלק ממנו |
| category | Single select | קטגוריה (אוכל, דלק, גן...) |
| entity | Single select | בית / עסק א׳ / עסק ב׳ |
| type | Single select | expense / income |
| confidence | Single select | auto / confirmed |
| times_used | Number | כמה פעמים החוק שימש |

### Accounts (חדש)

| שדה | סוג | תיאור |
|---|---|---|
| name | Single line text | דיסקונט, כאל *1234... |
| type | Single select | bank / credit_card |
| last_balance | Currency | יתרה אחרונה |
| last_scraped | Date | סקרייפינג אחרון |
| credentials_key | Single line text | שם ה-env var (לא הסיסמה) |

### Standing Orders (חדש)

| שדה | סוג | תיאור |
|---|---|---|
| name | Single line text | משכנתא, גן, פנסיה... |
| amount | Currency | סכום חודשי קבוע |
| day_of_month | Number | יום בחודש (לרוב 10) |
| entity | Single select | בית / עסק א׳ / עסק ב׳ |
| category | Single select | מגורים, חינוך, חיסכון... |

---

## לוגיקת סקרייפינג

### תדירות ותזמון

הסקרייפר רץ פעם ביום ב-06:00 בבוקר באמצעות cron job על Railway. משתמש בספריית israeli-bank-scrapers עם Puppeteer. דורש Node.js >= 22.12.0.

### Credentials לפי ספק

| ספק | CompanyType | שדות נדרשים |
|---|---|---|
| דיסקונט | discount | id, password, num |
| כאל | isracard | id, card6Digits, password |
| מקס | max | username, password |

### Flow יומי

1. פתיחת browser יחיד (Puppeteer) ושיתוף לכל הסקרייפרים באמצעות browserContext נפרד לכל אחד.
2. startDate - 30 יום אחורה (או מתאריך הסקרייפינג האחרון המוצלח).
3. לכל תנועה - יצירת hash מתאריך+סכום+תיאור+כרטיס. בדיקה מול hash קיים ב-Airtable - אם קיים, דילוג.
4. תנועות חדשות נכתבות ל-Transactions עם status=pending_classification.
5. עדכון יתרה ו-last_scraped בטבלת Accounts.

### טיפול בשגיאות

סקרייפרים נשברים מדי פעם כשהבנקים משנים את הממשק. המערכת תבצע retry עם backoff ותשלח התראה ב-Telegram על כל כשל סקרייפינג כולל פירוט השגיאה.

---

## לוגיקת סיווג

### Flow סיווג

כל תנועה חדשה עוברת את התהליך הבא:

**שלב 1: Cross-reference עם Sumit**

חיפוש התאמה בין תנועת בנק לחשבונית ב-Sumit לפי סכום וטווח תאריכים. אם נמצאה התאמה - סיווג אוטומטי לישות העסקית הרלוונטית, type=income. הערה: חשבוניות פתוחות כמעט לא קיימות ב-Sumit, לכן ה-cross-reference מתבסס על חשבוניות שכבר הונפקו ושולמו.

**שלב 2: חיפוש בטבלת חוקים**

חיפוש description contains match_pattern. חוק עם confidence=confirmed - סיווג אוטומטי. חוק עם confidence=auto - סיווג אוטומטי עם סימון לבדיקה.

**שלב 3: לא נמצאה התאמה**

status נשאר pending_classification. נשלחת התראה ב-Telegram עם כפתורי סיווג אינטראקטיביים.

### למידה ושיפור חוקים

כשמשתמש מסווג ידנית, המערכת שואלת: "ליצור חוק לכל התנועות מעסק זה?" אם כן - נוצר חוק חדש עם confidence=auto. אחרי שהחוק שימש מספר פעמים בהצלחה בלי שהמשתמש שינה - הוא משודרג ל-confidence=confirmed.

---

## הכנסות עתידיות - Airtable לקוחות

לכל אחד מהעסקים קיים Airtable base נפרד לניהול לקוחות, ובו מופיעות הכנסות עתידיות (עסקאות סגורות, תשלומים צפויים וכדומה).

### שימושים

תחזית תזרים: נתוני ההכנסות העתידיות מה-bases הללו מזינים את התרחיש האופטימי במודל התזרים.

Insights: השוואה בין הכנסות צפויות מהלקוחות לבין הכנסות שבפועל נכנסו.

מבנה ה-bases הללו יושלם בנפרד ל-Claude Code.

---

## מודל תזרים ל-10 לחודש

### נוסחה

**נקודת מוצא:** יתרת בנק נוכחית (מהסקרייפר).

**הכנסות צפויות - שלושה תרחישים:**

- **פסימי:** רק הכנסות שכבר נכנסו לבנק מ-1 בחודש עד היום.
- **ריאליסטי:** פסימי + ממוצע הכנסות (יום נוכחי עד 10) ב-3 חודשים אחרונים.
- **אופטימי:** ריאליסטי + הכנסות עתידיות מ-Airtable לקוחות.

**הוצאות ידועות:**

חיובי אשראי צפויים ב-10 (עסקאות שטרם נגבו - מהסקרייפר) + הוראות קבע ידועות (משכנתא, גן, פנסיות, קרנות השתלמות, קופות גמל) מטבלת Standing Orders.

**תחזית = יתרה + הכנסות צפויות - הוצאות ידועות**

התוצאה מוצגת כ-range של שלושה תרחישים, לא מספר בודד שעלול להטעות.

---

## Telegram Bot

### יכולות

- סיכום יומי: X תנועות חדשות, Y מסווגות, Z ממתינות לסיווג + תחזית תזרים ל-10.
- סיווג אינטראקטיבי באמצעות inline buttons - לחיצה על כפתור מסווגת תנועה, נוח יותר מלפתוח את האפליקציה.
- התראות על כשלי סקרייפינג כולל פירוט השגיאה.
- שני המשתמשים (בעלי העסקים) מחוברים לאותו בוט.

### דוגמת סיווג

תנועה לסיווג מגיעה כהודעה עם פרטי התנועה וכפתורי ישות (בית/עסק א׳/עסק ב׳). אחרי בחירה - שאלה "ליצור חוק?" עם כן/לא.

---

## הרחבות לאפליקציית React

### מסך סיווג תנועות

רשימת תנועות pending. לכל תנועה: תאריך, סכום, תיאור, מקור (כרטיס/בנק). בחירת קטגוריה + ישות. Toggle ליצירת חוק. שני המשתמשים רואים ויכולים לסווג.

### Dashboard תזרים

יתרה נוכחית. 3 תרחישי תחזית ל-10. גרף חודשי הכנסות vs הוצאות. פירוט חיובים צפויים ב-10.

### Insights

הוצאות לפי קטגוריה (pie chart). הוצאות לפי ישות (בית vs עסקים). טרנד חודשי. Top הוצאות חוזרות. השוואה חודש לחודש.

---

## שלבי פיתוח

| שלב | תיאור | תוצר |
|---|---|---|
| 1 | סקרייפר על Railway + כתיבה ל-Airtable + Telegram notification בסיסי | תנועות מגיעות, ללא סיווג |
| 2 | Classification engine + טבלת חוקים + סיווג ב-Telegram (inline buttons) | בניית בסיס חוקים |
| 3 | Sumit API integration + cross-reference הכנסות | סיווג אוטומטי של הכנסות עסקיות |
| 4 | תזרים ל-10 + dashboard באפליקציה | תחזית 3 תרחישים |
| 5 | Insights, דוחות, והשוואות | ניתוח הוצאות והכנסות |
| 6 | אינטגרציה עם Airtable לקוחות | הכנסות עתידיות מזינות תחזית |
